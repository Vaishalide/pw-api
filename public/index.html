<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PW THOR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { margin: 0; font-family: 'Poppins', sans-serif; background: #0e0f1b; color: white; }
    .header { background: #11132a; color: #ffc107; font-size: 1.8rem; text-transform: uppercase; padding: 1rem; text-align: center; font-weight: 600; }
    .grid { display: flex; flex-wrap: wrap; gap: 1rem; padding: 1rem; justify-content: center; }
    .card { background: #1e2036; padding: 1rem; border-radius: 10px; width: 250px; cursor: pointer; transition: 0.3s; }
    .card:hover { background: #2a2e4b; transform: translateY(-5px); }
    .card img { width: 100%; border-radius: 10px; }
    .card-title { margin-top: 0.5rem; font-weight: bold; text-align: center; }
    .section { padding: 1rem; }
    .btn { background: linear-gradient(90deg, #ffc107, #ff9800); color: #111; font-weight: 600; padding: 0.6rem 1.2rem; border-radius: 6px; text-decoration: none; }
    .btn:hover { transform: scale(1.05); }
    .hidden { display: none; }
    input { background: #15162b; color: white; border: 1px solid #3a3d5c; padding: 0.6rem 1rem; font-size: 1rem; border-radius: 8px; width: 80%; max-width: 400px; }

    .loader {
      border: 6px solid rgba(255, 255, 255, 0.1);
      border-top: 6px solid #ffc107;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 0.8s ease-in-out infinite;
      margin: 2rem auto;
      box-shadow: 0 0 15px #ffc10788;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>

<div style="display: flex; align-items: center; justify-content: center; gap: 1rem; padding: 1.5rem;">
  <img src="ChatGPT Image May 7, 2025, 08_57_25 PM.png" alt="PW THOR Logo" style="height: 60px;" />
  <h1 style="color: #ffc107; font-size: 2rem; margin: 0;">PW THOR</h1>
</div>

<div class="hidden" id="backBtn" style="padding: 1rem; cursor: pointer; color: gold; font-size: 1.2rem;">‚Üê Back</div>
<div id="searchBarWrapper" style="padding: 1rem; text-align: center;">
  <input id="searchInput" placeholder="Search batch by name...">
</div>

<div id="batchLoader" class="loader hidden"></div>
<div id="subjectLoader" class="loader hidden"></div>
<div id="topicLoader" class="loader hidden"></div>

<div class="grid" id="main"></div>
<div class="grid hidden" id="subjects"></div>
<div class="section hidden" id="topics"></div>

<script>
let batchOffset = 0;
const batchLimit = 10;
let allBatches = [];
let isLoading = false;

const main = document.getElementById('main');
const subjectsDiv = document.getElementById('subjects');
const topicsDiv = document.getElementById('topics');
const backBtn = document.getElementById('backBtn');
const searchBarWrapper = document.getElementById('searchBarWrapper');

let currentView = 'main';
let prevState = [];

function showView(view) {
  main.classList.add('hidden');
  subjectsDiv.classList.add('hidden');
  topicsDiv.classList.add('hidden');
  searchBarWrapper.style.display = view === 'main' ? '' : 'none';

  if (view === 'main') main.classList.remove('hidden');
  else if (view === 'subjects') subjectsDiv.classList.remove('hidden');
  else if (view === 'topics') topicsDiv.classList.remove('hidden');

  backBtn.classList.toggle('hidden', view === 'main');
  currentView = view;
}

backBtn.onclick = () => {
  const lastView = prevState.pop();
  if (lastView) showView(lastView);
};

function renderBatches() {
  if (isLoading) return;
  isLoading = true;

  const end = batchOffset + batchLimit;
  const slice = allBatches.slice(batchOffset, end);
  slice.forEach(data => {
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `<img src="${data.image}" alt="${data.name}"><div class="card-title">${data.name}</div>`;
    div.onclick = () => {
      prevState.push(currentView);
      loadSubjects(data.key);
    };
    main.appendChild(div);
  });

  batchOffset = end;
  isLoading = false;
  document.getElementById('batchLoader').classList.add('hidden');
}

async function loadBatches() {
  document.getElementById('batchLoader').classList.remove('hidden');
  const res = await fetch('/data');
  const json = await res.json();
  allBatches = Object.entries(json.batches).map(([key, val]) => ({ key, ...val }));
  renderBatches();
}

async function loadSubjects(batchId) {
  document.getElementById('subjectLoader').classList.remove('hidden');
  showView('subjects');
  subjectsDiv.innerHTML = '';

  const res = await fetch(`/data/batches/${batchId}/subjects`);
  const subjects = await res.json();

  document.getElementById('subjectLoader').classList.add('hidden');
  subjects.forEach(subject => {
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `<div class="card-title">${subject.name}</div>`;
    div.onclick = () => {
      prevState.push(currentView);
      loadTopics(batchId, subject.key);
    };
    subjectsDiv.appendChild(div);
  });
}

async function loadTopics(batchId, subjectId) {
  document.getElementById('topicLoader').classList.remove('hidden');
  showView('topics');
  topicsDiv.innerHTML = '';

  const res = await fetch(`/data/batches/${batchId}/subjects/${subjectId}/topics`);
  const topics = await res.json();

  const topicButtonsContainer = document.createElement('div');
  topicButtonsContainer.className = 'grid';

  const topicContent = document.createElement('div');
  topicContent.className = 'section';

  topics.forEach(topic => {
    const button = document.createElement('div');
    button.className = 'card';
    button.innerHTML = `<div class="card-title">${topic.name}</div>`;
    button.onclick = () => {
      topicButtonsContainer.style.display = 'none';

      const tabs = `
        <div style="display: flex; justify-content: center; gap: 1rem; margin-bottom: 1rem;">
          <button class="btn" onclick="switchTab('lectures')">Lectures</button>
          <button class="btn" onclick="switchTab('notes')">Notes</button>
          <button class="btn" onclick="switchTab('dpps')">DPPs</button>
        </div>
      `;

      topicContent.innerHTML = `<h2>${topic.name}</h2>` + tabs;

      const lecturesHtml = (topic.lectures || []).map(lecture => `
        <div style="margin-bottom: 2rem;">
          <a href="video.php?videoUrl=${encodeURIComponent(lecture.videoUrl)}&title=${encodeURIComponent(lecture.title)}">
            <img src="${lecture.thumbnail}" style="width:100%; max-width:400px; border-radius:10px; display:block; margin:1rem auto;" />
          </a>
          <div style="text-align:center;">${lecture.title}</div>
          ${(lecture.notes || []).map(note => `<div style="margin-top: 0.5rem;"><a href="${note.fileUrl}" target="_blank" class="btn">${note.title}</a></div>`).join('')}
          ${(lecture.dpps || []).map(dpp => `<div style="margin-top: 0.5rem;"><a href="${dpp.fileUrl}" target="_blank" class="btn">${dpp.title}</a></div>`).join('')}
        </div>
      `).join('');

      const notesHtml = (topic.notes || []).map(note => `<div style="margin-top: 1rem;"><a href="${note.fileUrl}" target="_blank" class="btn">${note.title}</a></div>`).join('');
      const dppsHtml = (topic.dpps || []).map(dpp => `<div style="margin-top: 1rem;"><a href="${dpp.fileUrl}" target="_blank" class="btn">${dpp.title}</a></div>`).join('');

      topicContent.innerHTML += `
        <div id="lecturesTab">${lecturesHtml}</div>
        <div id="notesTab" style="display:none;">${notesHtml}</div>
        <div id="dppsTab" style="display:none;">${dppsHtml}</div>
      `;

      window.switchTab = function(tabName) {
        document.getElementById('lecturesTab').style.display = tabName === 'lectures' ? 'block' : 'none';
        document.getElementById('notesTab').style.display = tabName === 'notes' ? 'block' : 'none';
        document.getElementById('dppsTab').style.display = tabName === 'dpps' ? 'block' : 'none';
      };
    };
    topicButtonsContainer.appendChild(button);
  });

  topicsDiv.appendChild(topicButtonsContainer);
  topicsDiv.appendChild(topicContent);
  document.getElementById('topicLoader').classList.add('hidden');
}

document.getElementById('searchInput').addEventListener('input', function () {
  const searchTerm = this.value.toLowerCase();
  const cards = main.getElementsByClassName('card');
  Array.from(cards).forEach(card => {
    const title = card.querySelector('.card-title').textContent.toLowerCase();
    card.style.display = title.includes(searchTerm) ? '' : 'none';
  });
});

window.addEventListener('scroll', () => {
  if (currentView !== 'main' || isLoading) return;

  if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 300) {
    document.getElementById('batchLoader').classList.remove('hidden');
    renderBatches();
  }
});

loadBatches();

// Disable right-click
document.addEventListener('contextmenu', event => event.preventDefault());

// Detect DevTools and redirect
(function () {
  const devtools = { open: false };
  const threshold = 160;
  const redirectURL = "https://www.google.com";

  function detectDevTools() {
    const widthThreshold = window.outerWidth - window.innerWidth > threshold;
    const heightThreshold = window.outerHeight - window.innerHeight > threshold;

    if (widthThreshold || heightThreshold) {
      if (!devtools.open) {
        devtools.open = true;
        window.location.href = redirectURL;
      }
    } else {
      devtools.open = false;
    }
  }

  setInterval(detectDevTools, 1000);
})();
</script>

<!-- Updated Popup -->
<div id="popup" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    background: #1e2036; color: white; padding: 20px; box-shadow: 0 0 20px #ffc10766; z-index: 9999; width: 320px; border-radius: 12px; text-align: center;">
  <button onclick="document.getElementById('popup').style.display='none'" 
    style="position: absolute; top: 5px; right: 10px; background: transparent; border: none; font-size: 20px; color: white;">&times;</button>
  <img id="popupImage" src="" alt="Popup Image" style="max-width: 100%; height: auto; border-radius: 8px;">
  <p id="popupText" style="margin: 15px 0;"></p>
  <a id="popupLink" href="#" target="_blank" 
     style="display: inline-block; padding: 10px 15px; background-color: #ffc107; color: #111; font-weight: bold; text-decoration: none; border-radius: 5px;">
     Join Telegram
  </a>
</div>

<script>
fetch('/data')
  .then(response => response.json())
  .then(data => {
    if (data.popup && data.popup.show) {
      document.getElementById('popupImage').src = data.popup.image;
      document.getElementById('popupText').textContent = data.popup.text;
      document.getElementById('popupLink').href = data.popup.link;
      document.getElementById('popup').style.display = 'block';
    }
  })
  .catch(error => console.error('Error loading popup data:', error));
</script>

</body>
</html>
